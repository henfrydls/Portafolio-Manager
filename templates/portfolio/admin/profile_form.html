{% extends "portfolio/admin/base_admin.html" %}
{% load static %}

{% block admin_title %}Mi Perfil{% endblock %}
{% block admin_subtitle %}Actualiza tu información personal y profesional{% endblock %}

{% block admin_actions %}
<a href="{% url 'portfolio:admin-dashboard' %}" class="btn-secondary-custom">
    <i class="fas fa-arrow-left"></i>Back to Dashboard
</a>
{% endblock %}

{% block admin_content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <div class="content-card">
        <div class="card-header-custom">
            <div>
                <h2 class="card-title-custom">Personal Information</h2>
                <p class="card-subtitle-custom">Update your public profile information</p>
            </div>
        </div>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Form-wide error alert (compact style) -->
            {% if form.errors %}
            <div class="alert alert-error" style="background: #FFEBEE; border-left: 4px solid #dc3545; padding: 12px 16px; border-radius: 6px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-exclamation-circle" style="color: #dc3545; font-size: 16px;"></i>
                <span style="font-size: 13px; color: #D32F2F; font-weight: 500;">Error al actualizar el perfil. Revisa los campos.</span>
            </div>
            {% endif %}
            
            <!-- Basic Information -->
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #242424; margin-bottom: 16px;">Basic Information</h3>
                
                <div style="margin-bottom: 20px;">
                    <label for="{{ form.name.id_for_label }}" class="form-label-custom">
                        {{ form.name.label }} <span style="color: #dc3545;">*</span>
                    </label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.name.errors.0 }}</div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.title.id_for_label }}" class="form-label-custom">
                        {{ form.title.label }} <span style="color: #dc3545;">*</span>
                    </label>
                    {{ form.title }}
                    <div class="form-text-custom">Tu título profesional (ej: Desarrollador Full Stack)</div>
                    {% if form.title.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.title.errors.0 }}</div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.bio.id_for_label }}" class="form-label-custom">
                        {{ form.bio.label }} <span style="color: #dc3545;">*</span>
                    </label>
                    {{ form.bio }}
                    <div class="form-text-custom">Brief description about you and your work</div>
                    {% if form.bio.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.bio.errors.0 }}</div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.profile_image.id_for_label }}" class="form-label-custom">
                        {{ form.profile_image.label }}
                    </label>
                    {{ form.profile_image }}
                    {% if form.profile_image.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.profile_image.errors.0 }}</div>
                    {% endif %}
                    {% if object.profile_image %}
                        <div style="margin-top: 12px;">
                            <small style="color: #6B6B6B;">Imagen actual:</small><br>
                            <img src="{{ object.profile_image.url }}" alt="{{ object.name }}" 
                                 style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-top: 8px;">
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Contact Information -->
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #242424; margin-bottom: 16px;">Contact Information</h3>
                
                <div style="margin-bottom: 20px;">
                    <label for="{{ form.email.id_for_label }}" class="form-label-custom">
                        {{ form.email.label }} <span style="color: #dc3545;">*</span>
                    </label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.email.errors.0 }}</div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.phone.id_for_label }}" class="form-label-custom">
                        {{ form.phone.label }}
                    </label>
                    {{ form.phone }}
                    {% if form.phone.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.phone.errors.0 }}</div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.location.id_for_label }}" class="form-label-custom">
                        {{ form.location.label }}
                    </label>
                    {{ form.location }}
                    <div class="form-text-custom">Tu ubicación (ej: Santo Domingo, República Dominicana)</div>
                    {% if form.location.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.location.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Social Links -->
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #242424; margin-bottom: 16px;">Enlaces Sociales</h3>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.linkedin_url.id_for_label }}" class="form-label-custom">
                        {{ form.linkedin_url.label }}
                    </label>
                    {{ form.linkedin_url }}
                    <div class="form-text-custom">Tu perfil de LinkedIn (opcional)</div>
                    {% if form.linkedin_url.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.linkedin_url.errors.0 }}</div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.github_url.id_for_label }}" class="form-label-custom">
                        {{ form.github_url.label }}
                    </label>
                    {{ form.github_url }}
                    <div class="form-text-custom">Tu perfil de GitHub (opcional)</div>
                    {% if form.github_url.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.github_url.errors.0 }}</div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.medium_url.id_for_label }}" class="form-label-custom">
                        {{ form.medium_url.label }}
                    </label>
                    {{ form.medium_url }}
                    <div class="form-text-custom">Tu perfil de Medium (opcional)</div>
                    {% if form.medium_url.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.medium_url.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Resume Settings -->
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #242424; margin-bottom: 16px;">Configuración del CV</h3>
                
                <div style="margin-bottom: 20px;">
                    <label for="{{ form.resume_pdf.id_for_label }}" class="form-label-custom">
                        {{ form.resume_pdf.label }}
                    </label>
                    {{ form.resume_pdf }}
                    <div class="form-text-custom">Upload your resume in English (PDF format)</div>
                    {% if form.resume_pdf.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.resume_pdf.errors.0 }}</div>
                    {% endif %}
                    {% if object.resume_pdf %}
                        <div style="margin-top: 8px; display: flex; align-items: center; gap: 12px;">
                            <div>
                                <small style="color: #6B6B6B;">Current file:</small>
                                <a href="{{ object.resume_pdf.url }}" target="_blank" style="color: #1976D2; text-decoration: none; margin-left: 8px;">
                                    <i class="fas fa-file-pdf"></i> View English CV
                                </a>
                            </div>
                            <button type="button" id="delete-resume-btn"
                                    style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="{{ form.resume_pdf_es.id_for_label }}" class="form-label-custom">
                        {{ form.resume_pdf_es.label }}
                    </label>
                    {{ form.resume_pdf_es }}
                    <div class="form-text-custom">Sube tu currículum en español (formato PDF)</div>
                    {% if form.resume_pdf_es.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.resume_pdf_es.errors.0 }}</div>
                    {% endif %}
                    {% if object.resume_pdf_es %}
                        <div style="margin-top: 8px; display: flex; align-items: center; gap: 12px;">
                            <div>
                                <small style="color: #6B6B6B;">Archivo actual:</small>
                                <a href="{{ object.resume_pdf_es.url }}" target="_blank" style="color: #1976D2; text-decoration: none; margin-left: 8px;">
                                    <i class="fas fa-file-pdf"></i> Ver CV en Español
                                </a>
                            </div>
                            <button type="button" id="delete-resume-es-btn"
                                    style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        {{ form.show_web_resume }}
                        <label for="{{ form.show_web_resume.id_for_label }}" class="form-label-custom" style="margin-bottom: 0;">
                            {{ form.show_web_resume.label }}
                        </label>
                    </div>
                    <div class="form-text-custom">Mostrar la versión web del currículum en el sitio</div>
                    {% if form.show_web_resume.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.show_web_resume.errors.0 }}</div>
                    {% endif %}
                </div>

                <div style="background: #FFF3CD; padding: 12px; border-radius: 6px; border-left: 4px solid #FFC107; margin-top: 16px;">
                    <p style="font-size: 13px; color: #856404; margin: 0;">
                        <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                        <strong>Nota:</strong> El sistema detecta automáticamente el idioma del usuario y muestra el CV correspondiente. Si solo tienes un CV, se mostrará ese independientemente del idioma.
                    </p>
                </div>
            </div>

            <!-- Languages Section -->
            <div style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: #242424; margin: 0;">Idiomas</h3>
                    <button type="button" id="add-language-btn" class="btn-primary-custom" style="padding: 6px 12px; font-size: 13px;">
                        <i class="fas fa-plus"></i> Agregar Idioma
                    </button>
                </div>
                
                <div id="languages-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Languages will be loaded here -->
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 24px; border-top: 1px solid #F2F2F2;">
                <a href="{% url 'portfolio:admin-dashboard' %}" class="btn-secondary-custom">
                    <i class="fas fa-times"></i>Cancel
                </a>
                <button type="submit" class="btn-primary-custom" id="save-profile-btn">
                    <i class="fas fa-save"></i>Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Language Modal (moved outside the main form to avoid conflicts) -->
<div id="language-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="font-size: 18px; font-weight: 600; color: #242424; margin: 0;">Agregar/Editar Idioma</h4>
            <button type="button" id="close-modal-btn" style="background: none; border: none; font-size: 24px; color: #6B6B6B; cursor: pointer; padding: 0; line-height: 1;">×</button>
        </div>
        
        <form id="language-form">
            <input type="hidden" id="language-id" name="language_id">
            
            <div style="margin-bottom: 16px;">
                <label class="form-label-custom">Idioma</label>
                <input type="text" id="language-name" name="name" class="form-control-custom" placeholder="Ej: English, Español, Français">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label class="form-label-custom">Nivel de Dominio</label>
                <select id="language-proficiency" name="proficiency" class="form-control-custom">
                    <option value="">Selecciona un nivel</option>
                    <option value="A1">A1 - Beginner</option>
                    <option value="A2">A2 - Elementary</option>
                    <option value="B1">B1 - Intermediate</option>
                    <option value="B2">B2 - Upper Intermediate</option>
                    <option value="C1">C1 - Advanced</option>
                    <option value="C2">C2 - Proficient</option>
                    <option value="Native">Native</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label class="form-label-custom">Orden de visualización</label>
                <input type="number" id="language-order" name="order" class="form-control-custom" value="0" min="0">
                <div class="form-text-custom">Orden en que aparecerá en el CV (menor número = primero)</div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" id="cancel-language-btn" class="btn-secondary-custom">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="submit" class="btn-primary-custom">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
console.log('Profile form JavaScript loading...');

// Add form-control-custom class to form fields
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded fired');
    const formFields = document.querySelectorAll('input[type="text"], input[type="email"], input[type="url"], textarea, select');
    formFields.forEach(field => {
        if (!field.classList.contains('form-check-input')) {
            field.classList.add('form-control-custom');
        }
    });
    
    // File input styling
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.classList.add('form-control-custom');
    });

    // Handle delete resume button (English)
    const deleteResumeBtn = document.getElementById('delete-resume-btn');
    if (deleteResumeBtn) {
        deleteResumeBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete the English CV? This action cannot be undone.')) {
                // Add a hidden input to mark resume for deletion
                const form = document.querySelector('form[enctype="multipart/form-data"]');
                if (form) {
                    const deleteInput = document.createElement('input');
                    deleteInput.type = 'hidden';
                    deleteInput.name = 'delete_resume';
                    deleteInput.value = 'true';
                    form.appendChild(deleteInput);

                    // Submit the form
                    form.submit();
                }
            }
        });
    }

    // Handle delete resume button (Spanish)
    const deleteResumeEsBtn = document.getElementById('delete-resume-es-btn');
    if (deleteResumeEsBtn) {
        deleteResumeEsBtn.addEventListener('click', function() {
            if (confirm('¿Estás seguro de que quieres eliminar el CV en Español? Esta acción no se puede deshacer.')) {
                // Add a hidden input to mark Spanish resume for deletion
                const form = document.querySelector('form[enctype="multipart/form-data"]');
                if (form) {
                    const deleteInput = document.createElement('input');
                    deleteInput.type = 'hidden';
                    deleteInput.name = 'delete_resume_es';
                    deleteInput.value = 'true';
                    form.appendChild(deleteInput);

                    // Submit the form
                    form.submit();
                }
            }
        });
    }

    // Language Management
    const languageModal = document.getElementById('language-modal');
    const languageForm = document.getElementById('language-form');
    const languagesList = document.getElementById('languages-list');
    const addLanguageBtn = document.getElementById('add-language-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelLanguageBtn = document.getElementById('cancel-language-btn');

    // Load languages
    function loadLanguages() {
        fetch('/admin-panel/languages/list/')
            .then(response => response.json())
            .then(data => {
                languagesList.innerHTML = '';
                if (data.languages.length === 0) {
                    languagesList.innerHTML = '<div style="padding: 16px; text-align: center; color: #6B6B6B; background: #f8f8f8; border-radius: 6px;">No hay idiomas agregados. Haz clic en "Agregar Idioma" para comenzar.</div>';
                } else {
                    data.languages.forEach(lang => {
                        const langCard = document.createElement('div');
                        langCard.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f8f8f8; border-radius: 6px; border: 1px solid #F2F2F2;';
                        langCard.innerHTML = `
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: #242424; margin-bottom: 4px;">
                                    <i class="fas fa-language" style="margin-right: 6px; color: #1976D2;"></i>
                                    ${lang.name}
                                </div>
                                <div style="font-size: 12px; color: #6B6B6B;">
                                    Nivel: <strong>${lang.proficiency}</strong> • Orden: ${lang.order}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="edit-language-btn" data-id="${lang.id}" 
                                        style="background: #1976D2; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button type="button" class="delete-language-btn" data-id="${lang.id}" 
                                        style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        `;
                        languagesList.appendChild(langCard);
                    });

                    // Add event listeners to edit and delete buttons
                    document.querySelectorAll('.edit-language-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const langId = this.dataset.id;
                            editLanguage(langId);
                        });
                    });

                    document.querySelectorAll('.delete-language-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const langId = this.dataset.id;
                            deleteLanguage(langId);
                        });
                    });
                }
            })
            .catch(error => {
                console.error('Error loading languages:', error);
                languagesList.innerHTML = '<div style="padding: 16px; text-align: center; color: #dc3545; background: #f8d7da; border-radius: 6px;">Error al cargar los idiomas.</div>';
            });
    }

    // Open modal for adding language
    if (addLanguageBtn) {
        addLanguageBtn.addEventListener('click', function() {
            document.getElementById('language-id').value = '';
            document.getElementById('language-name').value = '';
            document.getElementById('language-proficiency').value = '';
            document.getElementById('language-order').value = '0';
            if (languageModal) {
                languageModal.style.display = 'flex';
            }
        });
    }

    // Close modal
    function closeModal() {
        if (languageModal) {
            languageModal.style.display = 'none';
        }
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }
    
    if (cancelLanguageBtn) {
        cancelLanguageBtn.addEventListener('click', closeModal);
    }

    // Close modal when clicking outside
    if (languageModal) {
        languageModal.addEventListener('click', function(e) {
            if (e.target === languageModal) {
                closeModal();
            }
        });
    }

    // Edit language
    function editLanguage(langId) {
        fetch(`/admin-panel/languages/${langId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('language-id').value = data.id;
                document.getElementById('language-name').value = data.name;
                document.getElementById('language-proficiency').value = data.proficiency;
                document.getElementById('language-order').value = data.order;
                languageModal.style.display = 'flex';
            })
            .catch(error => {
                console.error('Error loading language:', error);
                alert('Error al cargar el idioma.');
            });
    }

    // Delete language
    function deleteLanguage(langId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este idioma?')) {
            return;
        }

        fetch(`/admin-panel/languages/${langId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadLanguages();
            } else {
                alert('Error al eliminar el idioma.');
            }
        })
        .catch(error => {
            console.error('Error deleting language:', error);
            alert('Error al eliminar el idioma.');
        });
    }

    // Submit language form
    if (languageForm) {
        languageForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const langId = document.getElementById('language-id').value;
            const formData = {
                name: document.getElementById('language-name').value,
                proficiency: document.getElementById('language-proficiency').value,
                order: document.getElementById('language-order').value
            };

            const url = langId ? `/admin-panel/languages/${langId}/update/` : '/admin-panel/languages/create/';

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    loadLanguages();
                } else {
                    alert('Error al guardar el idioma: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error saving language:', error);
                alert('Error al guardar el idioma.');
            });
        });
    }

    // Load languages on page load
    loadLanguages();

    // Debug: Check form submission - use enctype to get the correct form
    const mainForm = document.querySelector('form[enctype="multipart/form-data"]');
    const saveBtn = document.getElementById('save-profile-btn');
    
    console.log('Main form:', mainForm);
    console.log('Save button:', saveBtn);
    
    if (saveBtn && mainForm) {
        // Ensure the button submits the correct form
        saveBtn.addEventListener('click', function(e) {
            console.log('Save button clicked!');
            e.preventDefault(); // Prevent default to handle manually
            
            console.log('Form validity:', mainForm.checkValidity());
            
            if (!mainForm.checkValidity()) {
                console.log('Form has validation errors');
                mainForm.reportValidity();
            } else {
                console.log('Form is valid, submitting manually...');
                // Manually submit the form
                mainForm.submit();
            }
        });
    }
    
    if (mainForm) {
        mainForm.addEventListener('submit', function(e) {
            console.log('Form submit event fired! Form will be submitted now.');
            // Don't prevent default - let it submit normally
        });
    } else {
        console.error('Main form not found!');
    }
});
</script>
{% endblock %}