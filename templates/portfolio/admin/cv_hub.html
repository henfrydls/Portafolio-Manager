{% extends "portfolio/admin/base_admin.html" %}
{% load static i18n %}

{% block admin_title %}{% trans "CV Management" %}{% endblock %}
{% block admin_subtitle %}{% trans "Manage your work experience, education and technical skills" %}{% endblock %}

{% block admin_content %}
<!-- CV Sections -->
<div class="content-card">
    <div class="card-header-custom">
        <div>
            <h2 class="card-title-custom">{% trans "CV Sections" %}</h2>
            <p class="card-subtitle-custom">{{ stats.total_experiences }} {% trans "experiences" %} • {{ stats.total_education }} {% trans "education records" %} • {{ stats.total_skills }} {% trans "skills" %}</p>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
        <!-- Experience -->
        <div style="padding: 24px; border: 1px solid #F2F2F2; border-radius: 8px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #242424; margin: 0 0 8px 0;">Work Experience</h3>
            <p style="color: #6B6B6B; margin: 0 0 16px 0; font-size: 14px;">{{ stats.total_experiences }} records</p>
            
            {% if stats.current_job %}
                <div style="margin-bottom: 16px; padding: 12px; background: #F8F9FA; border-radius: 6px;">
                    <div style="font-weight: 500; color: #242424;">{{ stats.current_job.position }}</div>
                    <div style="font-size: 14px; color: #6B6B6B;">{{ stats.current_job.company }} • Current</div>
                </div>
            {% endif %}
            
            <div style="display: flex; gap: 12px;">
                <a href="{% url 'portfolio:admin-experience-list' %}" class="btn-primary-custom">{% trans "View All" %}</a>
                <a href="{% url 'portfolio:admin-experience-create' %}" class="btn-secondary-custom">{% trans "Add" %}</a>
            </div>
        </div>

        <!-- Education -->
        <div style="padding: 24px; border: 1px solid #F2F2F2; border-radius: 8px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #242424; margin: 0 0 8px 0;">Education</h3>
            <p style="color: #6B6B6B; margin: 0 0 16px 0; font-size: 14px;">{{ stats.total_education }} records</p>
            
            {% if stats.current_education > 0 %}
                <div style="margin-bottom: 16px; padding: 12px; background: #F8F9FA; border-radius: 6px;">
                    <div style="font-size: 14px; color: #242424;">{{ stats.current_education }} {% trans "education in progress" %}</div>
                </div>
            {% endif %}

            <div style="display: flex; gap: 12px;">
                <a href="{% url 'portfolio:admin-education-list' %}" class="btn-primary-custom">{% trans "View All" %}</a>
                <a href="{% url 'portfolio:admin-education-create' %}" class="btn-secondary-custom">{% trans "Add" %}</a>
            </div>
        </div>

        <!-- Skills -->
        <div style="padding: 24px; border: 1px solid #F2F2F2; border-radius: 8px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #242424; margin: 0 0 8px 0;">Skills</h3>
            <p style="color: #6B6B6B; margin: 0 0 16px 0; font-size: 14px;">{{ stats.total_skills }} {% trans "skills in" %} {{ stats.skill_categories }} {% trans "categories" %}</p>

            <div style="display: flex; gap: 12px;">
                <a href="{% url 'portfolio:admin-skill-list' %}" class="btn-primary-custom">{% trans "View All" %}</a>
                <a href="{% url 'portfolio:admin-skill-create' %}" class="btn-secondary-custom">{% trans "Add" %}</a>
            </div>
        </div>
    </div>
</div>

<!-- Languages -->
<div class="content-card">
    <div class="card-header-custom" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="card-title-custom">{% trans "Languages" %}</h2>
            <p class="card-subtitle-custom">{% trans "Track the languages you speak and their proficiency level." %}</p>
        </div>
        <button type="button" id="add-language-btn" class="btn-primary-custom">
            <i class="fas fa-plus"></i>{% trans "Add Language" %}
        </button>
    </div>

    <div id="languages-list" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Filled dynamically -->
    </div>
</div>

<!-- Quick Actions -->
<div class="content-card">
    <div class="card-header-custom">
        <div>
            <h2 class="card-title-custom">{% trans "Quick Actions" %}</h2>
            <p class="card-subtitle-custom">{% trans "Useful links to manage your CV" %}</p>
        </div>
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 16px;">
        <a href="{% url 'portfolio:resume' %}" target="_blank" class="btn-primary-custom">
            <i class="fas fa-eye"></i>{% trans "View Public CV" %}
        </a>
        <a href="{% url 'portfolio:admin-profile-edit' %}" class="btn-secondary-custom">
            <i class="fas fa-user"></i>{% trans "Edit Profile" %}
        </a>
    </div>
</div>

<!-- Language Modal -->
<div id="language-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: #fff; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="font-size: 18px; font-weight: 600; color: #242424; margin: 0;">{% trans "Add / Edit Language" %}</h4>
            <button type="button" id="close-modal-btn" style="background: none; border: none; font-size: 24px; color: #6B6B6B; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        </div>

        <form id="language-form">
            {% csrf_token %}
            <input type="hidden" id="language-id" name="language_id">

            <!-- Language Selection Strategy -->
            <div style="margin-bottom: 16px;">
                <label class="form-label-custom" for="language-select">{% trans "Select Language" %}</label>
                <select id="language-select" class="form-control-custom">
                    <option value="">{% trans "Choose a language..." %}</option>
                    <!-- Populated by JS -->
                    <option value="other">{% trans "Other / Custom" %}</option>
                </select>
            </div>

            <!-- Manual Fields container -->
            <div id="manual-language-fields" style="display: none; border-left: 2px solid #F2F2F2; padding-left: 12px; margin-left: 4px;">
                <div style="margin-bottom: 16px;">
                    <label class="form-label-custom" for="language-name">{% trans "Name" %}</label>
                    <input type="text" id="language-name" name="name" class="form-control-custom" placeholder="{% trans 'E.g: English, Spanish' %}">
                </div>

                <div style="margin-bottom: 16px;">
                    <label class="form-label-custom" for="language-code">{% trans "ISO Code" %}</label>
                    <input type="text" id="language-code" name="code" class="form-control-custom" placeholder="{% trans 'E.g: en, es, fr' %}">
                    <p class="form-text-custom">{% trans "Two-letter ISO 639-1 code" %}</p>
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <label class="form-label-custom" for="language-proficiency">{% trans "Proficiency Level" %}</label>
                <select id="language-proficiency" name="proficiency" class="form-control-custom">
                    <option value="">{% trans "Select a level" %}</option>
                    <option value="A1">A1 - {% trans "Beginner" %}</option>
                    <option value="A2">A2 - {% trans "Elementary" %}</option>
                    <option value="B1">B1 - {% trans "Intermediate" %}</option>
                    <option value="B2">B2 - {% trans "Upper Intermediate" %}</option>
                    <option value="C1">C1 - {% trans "Advanced" %}</option>
                    <option value="C2">C2 - {% trans "Proficient" %}</option>
                    <option value="Native">{% trans "Native" %}</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="form-label-custom" for="language-order">{% trans "Display Order" %}</label>
                <input type="number" id="language-order" name="order" class="form-control-custom" value="0" min="0">
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" id="cancel-language-btn" class="btn-secondary-custom">
                    <i class="fas fa-times"></i>{% trans "Cancel" %}
                </button>
                <button type="submit" class="btn-primary-custom">
                    <i class="fas fa-save"></i>{% trans "Save" %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}


{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const languagesList = document.getElementById('languages-list');
    const languageModal = document.getElementById('language-modal');
    const languageForm = document.getElementById('language-form');
    const addLanguageBtn = document.getElementById('add-language-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelLanguageBtn = document.getElementById('cancel-language-btn');
    const csrfToken = (typeof getCookie === 'function' && getCookie('csrftoken')) || (document.querySelector('[name=csrfmiddlewaretoken]') || {value: ''}).value || '';

    if (!languagesList || !languageModal || !languageForm) {
        return;
    }

    const EMPTY_LANGUAGES_MSG = "{{ _('No languages added yet. Click \'Add Language\' to begin.')|escapejs }}";
    const ERROR_LOADING_LANGUAGES_MSG = "{{ _('Error loading languages.')|escapejs }}";
    const ERROR_LOADING_LANGUAGE_MSG = "{{ _('Error loading language.')|escapejs }}";
    const ERROR_DELETING_LANGUAGE_MSG = "{{ _('Error deleting language.')|escapejs }}";
    const ERROR_SAVING_LANGUAGE_MSG = "{{ _('Error saving language.')|escapejs }}";
    const UNKNOWN_ERROR_MSG = "{{ _('Unknown error')|escapejs }}";
    const LEVEL_LABEL = "{{ _('Level')|escapejs }}";
    const ORDER_LABEL = "{{ _('Order')|escapejs }}";
    const DELETE_CONFIRM_MSG = "{{ _('Are you sure you want to delete this language?')|escapejs }}";
    const NO_CODE_LABEL = "{{ _('Not provided')|escapejs }}";

    // Top 10 Common Languages (Localized)
    const COMMON_LANGUAGES = [
        { name: "{% trans 'Mandarin' %}", code: "zh" },
        { name: "{% trans 'Spanish' %}", code: "es" },
        { name: "{% trans 'English' %}", code: "en" },
        { name: "{% trans 'Portuguese' %}", code: "pt" },
        { name: "{% trans 'Russian' %}", code: "ru" },
        { name: "{% trans 'Japanese' %}", code: "ja" },
        { name: "{% trans 'German' %}", code: "de" },
        { name: "{% trans 'Korean' %}", code: "ko" },
        { name: "{% trans 'French' %}", code: "fr" },
        { name: "{% trans 'Italian' %}", code: "it" }
    ];

    // Initialize Dropdown
    const languageSelect = document.getElementById('language-select');
    const manualFields = document.getElementById('manual-language-fields');
    const nameInput = document.getElementById('language-name');
    const codeInput = document.getElementById('language-code');
    
    function initLanguageDropdown() {
        COMMON_LANGUAGES.forEach(lang => {
            const option = document.createElement('option');
            option.value = lang.code;
            option.textContent = lang.name;
            option.dataset.name = lang.name;
            languageSelect.insertBefore(option, languageSelect.lastElementChild); // Insert before 'Other'
        });

        languageSelect.addEventListener('change', function() {
            const value = this.value;
            if (value === 'other') {
                manualFields.style.display = 'block';
                nameInput.value = '';
                codeInput.value = '';
                nameInput.focus();
            } else if (value) {
                // Pre-fill and hide manual fields (or show read-only if preferred, here we hide for cleanliness)
                // We'll hide them to keep UX simple as requested
                manualFields.style.display = 'none';
                const selectedOption = this.options[this.selectedIndex];
                nameInput.value = selectedOption.dataset.name;
                codeInput.value = value;
            } else {
                manualFields.style.display = 'none';
                nameInput.value = '';
                codeInput.value = '';
            }
        });
        
        // Ensure manual change updates select if needed (optional reverse logic)
    }

    initLanguageDropdown();

    function renderLanguages(languages) {
        languagesList.innerHTML = '';

        if (!languages.length) {
            languagesList.innerHTML = `<div style="padding: 16px; text-align: center; color: #6B6B6B; background: #f8f8f8; border-radius: 6px;">${EMPTY_LANGUAGES_MSG}</div>`;
            return;
        }

        languages.forEach(lang => {
            const card = document.createElement('div');
            card.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f8f8f8; border-radius: 6px; border: 1px solid #F2F2F2;';
            card.innerHTML = `
                <div>
                    <div style="font-size: 14px; font-weight: 500; color: #242424; margin-bottom: 4px;">
                        <i class="fas fa-language" style="margin-right: 6px; color: #1976D2;"></i>
                        ${lang.name}
                        <span style="color: #6B6B6B; font-weight: 400;">(${lang.code || '&mdash;'})</span>
                    </div>
                    <div style="font-size: 12px; color: #6B6B6B;">
                        ${LEVEL_LABEL}: <strong>${lang.proficiency || NO_CODE_LABEL}</strong> · ${ORDER_LABEL}: ${lang.order}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="button" class="edit-language-btn" data-language-id="${lang.id}" style="background: #1976D2; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-edit"></i>{% trans "Edit" %}
                    </button>
                    <button type="button" class="delete-language-btn" data-language-id="${lang.id}" style="background: #dc3545; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-trash"></i>{% trans "Delete" %}
                    </button>
                </div>
            `;
            languagesList.appendChild(card);
        });

        languagesList.querySelectorAll('.edit-language-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const languageId = this.getAttribute('data-language-id');
                editLanguage(languageId);
            });
        });

        languagesList.querySelectorAll('.delete-language-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const languageId = this.getAttribute('data-language-id');
                deleteLanguage(languageId);
            });
        });
    }

    function loadLanguages() {
        fetch('/admin-panel/languages/list/')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || UNKNOWN_ERROR_MSG);
                }
                renderLanguages(data.languages || []);
            })
            .catch(error => {
                console.error('Error loading languages:', error);
                languagesList.innerHTML = `<div style="padding: 16px; text-align: center; color: #dc3545; background: #f8d7da; border-radius: 6px;">${ERROR_LOADING_LANGUAGES_MSG}</div>`;
            });
    }

    function openModal() {
        languageForm.reset();
        document.getElementById('language-id').value = '';
        document.getElementById('language-order').value = 0;
        
        // Reset Dropdown
        languageSelect.value = '';
        manualFields.style.display = 'none';
        
        languageModal.style.display = 'flex';
    }

    function closeModal() {
        languageModal.style.display = 'none';
    }

    function editLanguage(languageId) {
        fetch(`/admin-panel/languages/${languageId}/`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || UNKNOWN_ERROR_MSG);
                }
                document.getElementById('language-id').value = data.id;
                document.getElementById('language-name').value = data.name || '';
                document.getElementById('language-code').value = data.code || '';
                document.getElementById('language-proficiency').value = data.proficiency || '';
                document.getElementById('language-order').value = data.order ?? 0;
                
                // Try to match with common languages
                const foundLang = COMMON_LANGUAGES.find(l => l.code === data.code);
                if (foundLang) {
                    languageSelect.value = foundLang.code;
                    manualFields.style.display = 'none';
                } else {
                    languageSelect.value = 'other';
                    manualFields.style.display = 'block';
                }
                
                // Always set values just in case
                document.getElementById('language-name').value = data.name || '';
                document.getElementById('language-code').value = data.code || '';

                languageModal.style.display = 'flex';
            })
            .catch(error => {
                console.error('Error loading language:', error);
                alert(ERROR_LOADING_LANGUAGE_MSG);
            });
    }

    function deleteLanguage(languageId) {
        if (!confirm(DELETE_CONFIRM_MSG)) {
            return;
        }

        fetch(`/admin-panel/languages/${languageId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadLanguages();
                } else {
                    throw new Error(data.error || UNKNOWN_ERROR_MSG);
                }
            })
            .catch(error => {
                console.error('Error deleting language:', error);
                alert(ERROR_DELETING_LANGUAGE_MSG);
            });
    }

    languageForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const languageId = document.getElementById('language-id').value;
        const payload = {
            name: document.getElementById('language-name').value,
            code: document.getElementById('language-code').value,
            proficiency: document.getElementById('language-proficiency').value,
            order: document.getElementById('language-order').value
        };

        const url = languageId
            ? `/admin-panel/languages/${languageId}/update/`
            : '/admin-panel/languages/create/';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    loadLanguages();
                } else {
                    throw new Error(data.error || UNKNOWN_ERROR_MSG);
                }
            })
            .catch(error => {
                console.error('Error saving language:', error);
                alert(`${ERROR_SAVING_LANGUAGE_MSG}: ${error.message || UNKNOWN_ERROR_MSG}`);
            });
    });

    addLanguageBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    cancelLanguageBtn.addEventListener('click', closeModal);

    languageModal.addEventListener('click', function(event) {
        if (event.target === languageModal) {
            closeModal();
        }
    });

    loadLanguages();
});
</script>
{% endblock %}

