name: Validate CI/CD Setup

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/**'
      - '.flake8'
      - 'pyproject.toml'

jobs:
  validate-workflows:
    name: Validate Workflow Syntax
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate workflow files
        run: |
          echo "Validating workflow files..."
          for file in .github/workflows/*.yml; do
            echo "Checking $file"
            # Basic YAML syntax check
            python -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
          echo "✅ All workflow files are valid YAML"

  validate-config:
    name: Validate Configuration Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Validate pyproject.toml
        run: |
          pip install toml
          python -c "import toml; toml.load('pyproject.toml')" || exit 1
          echo "✅ pyproject.toml is valid"

      - name: Validate .flake8
        run: |
          if [ -f .flake8 ]; then
            echo "✅ .flake8 exists"
          else
            echo "❌ .flake8 not found"
            exit 1
          fi

  test-docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: test-image:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create .env file for validation
        run: cp .env.example .env

      - name: Test Docker Compose
        run: |
          docker compose -f docker-compose.yml config
          echo "✅ Docker Compose configuration is valid"

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-workflows, validate-config, test-docker-build]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## CI/CD Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Validation: ${{ needs.validate-workflows.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Config Validation: ${{ needs.validate-config.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build Test: ${{ needs.test-docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-workflows.result }}" == "success" ] && \
             [ "${{ needs.validate-config.result }}" == "success" ] && \
             [ "${{ needs.test-docker-build.result }}" == "success" ]; then
            echo "✅ All validations passed! CI/CD setup is ready." >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some validations failed. Please review the errors above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
